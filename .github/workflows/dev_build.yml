name: Dev Build

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'     
        required: true
        default: 'warning'
      tags:
        description: 'Forced build'
  push:
    branches:
      - dev
    paths-ignore:
      - '.github/**'

jobs:
  build-windows:
    name: Windows Build
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install requirements
        run: pip install -r requirements/Windows/requirements.txt
      - name: Install builder
        run: pip install nuitka
      - name: Build app
        run: |
          nuitka --onefile \
            --windows-icon=logo/logo.ico \
            --follow-imports \
            --output-dir=dist \
            --windows-uac-uiaccess \
            --output-filename=PyContinuity \
            --windows-product-name="PyContinuity" \
            -o PyContinuity \
            start.py
      - name: Create zip of the app
        run: 7z a -tzip PyContinuity_windows.zip dist/PyContinuity.exe
      - uses: actions/upload-artifact@v4
        with:
          name: PyContinuity_windows
          path: PyContinuity_windows.zip

  build-mac:
    name: MacOSX (silicon) Build
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install gobject-introspection
        run: brew install gobject-introspection
      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install requirements
        run: |
          pip install -r requirements/Osx/requirements.txt
          pip install nuitka
      - name: Install ccache
        run: |
          brew install ccache
      - name: Build app
        run: |
          nuitka --standalone \
            --macos-app-icon=logo/logo.icns \
            --follow-imports \
            --output-dir=dist \
            --macos-create-app-bundle \
            --disable-console \
            --output-filename=PyContinuity \
            --macos-app-protected-resource="NSInputMonitoringUsageDescription:Questa applicazione richiede l'accesso all'input della tastiera per monitorare le tue digitazioni." \
            --macos-app-protected-resource="NSAccessibilityUsageDescription:Questa applicazione necessita dell'accesso alle funzionalità di accessibilità per interagire con altre applicazioni." \
            --product-name="PyContinuity" \
            -o PyContinuity \
            start.py
          
            mv dist/start.app dist/PyContinuity.app

      - name: Decode and import certificate
        env:
          MAC_CERTIFICATE: ${{ secrets.CERTIFICATE }}
          MAC_CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          echo "$MAC_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p "action" build.keychain
          security import certificate.p12 -k build.keychain -P "$MAC_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security list-keychains -s build.keychain
          security unlock-keychain -p "action" build.keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "action" build.keychain
      - name: Change permissions
        run: chmod +x dist/PyContinuity.app/Contents/MacOS/*

      - name: Sign the app
        run: |
          codesign --deep --force --verify --verbose --sign "PyContinuity" dist/PyContinuity.app

      - name: Create tarball of the app
        run: tar -czvf "PyContinuity_macos(silicon).tar.gz" -C dist PyContinuity.app

      - uses: actions/upload-artifact@v4
        with:
          name: PyContinuity_macos(silicon)
          path: PyContinuity_macos(silicon).tar.gz